<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../lms-query-behavior.html">

<script>
  window.LMS = window.LMS || {};

  LMS.QuestionQueryBehaviorImpl = {
    properties: {
      queryFields: {
        type: String,
        notify: true
      },
      queryTerm: {
        type: String,
        notify: true
      },
      selectedLevels: {
        type: Array,
        notify: true
      },
      selectedSubjects: {
        type: Array,
        notify: true
      },
      selectedTypes: {
        type: Array,
        notify: true
      },
      selectedOwners: {
        type: Array,
        notify: true
      }
    },

    observers: [
      '_updateQuery(queryTerm)',
      '_updateFilters(selectedLevels, selectedSubjects, '
        + 'selectedTypes, selectedOwners)'
    ],

    _updateQuery: function(queryTerm) {
      var query = '';

      if (queryTerm && (queryTerm.trim() !== '')) {
        query = this.queryFields + ':LIKE ' + queryTerm;
      }

      this.query = query;
      this.filters = '';
      this.offset = 0;
    },

    _updateFilters: function(
        selectedLevels, selectedSubjects,
        selectedTypes, selectedOwners) {

      var filters = [];

      if (selectedLevels.length > 0) {
        var levels = selectedLevels.filter(function(level) {
          return level !== 'ALL';
        });

        if (levels.length > 0) {
          var levelFilter = levels.join(' OR ');
          filters.push('level.id:MUST ' + levelFilter);
        }
      }

      if (selectedSubjects.length > 0) {
        var subjects = selectedSubjects.filter(function(subject) {
          return subject !== 'ALL';
        });

        if (subjects.length > 0) {
          var subjectFilter = subjects.join(' OR ');
          filters.push('subject.id:MUST ' + subjectFilter);
        }
      }

      if (selectedTypes.length > 0) {
        var types = selectedTypes.filter(function(type) {
          return type !== 'ALL';
        });

        if (types.length > 0) {
          var typeFilter = types.join(' OR ');
          filters.push('type:MUST ' + typeFilter);
        }
      }

      if (selectedOwners.length === 1) {
        var owners = selectedOwners.filter(function(owner) {
          return owner !== 'ANYONE';
        });

        owners.forEach(function(owner) {
          if (owner === "ME") {
            filters.push('createdBy.id:MUST ' + this.userId);

          } else if (owner === "NOT_ME") {
            filters.push('createdBy.id:NOT ' + this.userId);
          }
        }, this);
      }

      this.filters = filters.join(' ');
      this.offset = 0;
    }
  };

  LMS.QuestionQueryBehavior = [
    LMS.QueryBehavior,
    LMS.QuestionQueryBehaviorImpl
  ];
</script>