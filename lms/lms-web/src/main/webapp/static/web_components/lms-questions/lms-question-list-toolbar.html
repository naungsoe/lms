<link rel="import" href="../lms-default.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="lms-question-list-toolbar">

  <template strip-whitespace>
    <style include="lms-style">
      paper-dropdown-menu {
        margin-top: 8px;
      }
    </style>

    <iron-ajax url="[[filtersUrl]]" method="GET"
               handle-as="json" content-type="application/json"
               on-response="_onAjaxResponse"></iron-ajax>

    <paper-toolbar>
      <paper-menu-button horizontal-align="left" vertical-align="top" ignore-select>
        <paper-icon-button class="dropdown-trigger" icon="filter-list"></paper-icon-button>
        <div class="dropdown-content" filter-list>
          <div class="filter-content" flex-vertical>
            <template is="dom-if" if="[[_isReady(resources, filters)]]">
              <paper-dropdown-menu no-label-float flex-auto>
                <paper-listbox name="levels" class="dropdown-content"
                               selected="ALL" attr-for-selected="value">
                  <paper-item value="ALL">[[localize('labelAllLevels')]]</paper-item>
                  <template is="dom-repeat" items="[[filters.levels]]" as="level">
                    <paper-item value="[[level.value]]">[[level.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu no-label-float flex-auto>
                <paper-listbox name="subjects" class="dropdown-content"
                               selected="ALL" attr-for-selected="value">
                  <paper-item value="ALL">[[localize('labelAllSubjects')]]</paper-item>
                  <template is="dom-repeat" items="[[filters.subjects]]" as="subject">
                    <paper-item value="[[subject.value]]">[[subject.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu no-label-float flex-auto>
                <paper-listbox name="types" class="dropdown-content"
                               selected="ALL" attr-for-selected="value">
                  <paper-item value="ALL">[[localize('labelAllQuestionTypes')]]</paper-item>
                  <template is="dom-repeat" items="[[filters.types]]" as="type">
                    <template is="dom-if" if="[[_equals(type.name, 'MULTIPLE_CHOICE')]]">
                      <paper-item value="[[type.value]]">[[localize('labelMultipleChoice')]]</paper-item>
                    </template>
                    <template is="dom-if" if="[[_equals(type.name, 'MULTIPLE_RESPONSE')]]">
                      <paper-item value="[[type.value]]">[[localize('labelMultipleResponse')]]</paper-item>
                    </template>
                    <template is="dom-if" if="[[_equals(type.name, 'SHORT_ANSWER')]]">
                      <paper-item value="[[type.value]]">[[localize('labelShortAnswer')]]</paper-item>
                    </template>
                    <template is="dom-if" if="[[_equals(type.name, 'ESSAY')]]">
                      <paper-item value="[[type.value]]">[[localize('labelEssay')]]</paper-item>
                    </template>
                    <template is="dom-if" if="[[_equals(type.name, 'COMPOSITE')]]">
                      <paper-item value="[[type.value]]">[[localize('labelComposite')]]</paper-item>
                    </template>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu no-label-float flex-auto>
                <paper-listbox name="owners" class="dropdown-content"
                               selected="ANYONE" attr-for-selected="value">
                  <paper-item value="ANYONE">[[localize('labelOwnedByAnyone')]]</paper-item>
                  <paper-item value="ME">[[localize('labelOwnedByMe')]]</paper-item>
                  <paper-item value="NOT_ME">[[localize('labelNotOwnerByMe')]]</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
            </template>
          </div>
          <div class="filter-actions" justified-end>
            <paper-button on-tap="_onResetTap">
              [[localize('buttonResetFilter')]]
            </paper-button>
            <paper-button on-tap="_onApplyTap">
              [[localize('buttonApplyFilter')]]
            </paper-button>
          </div>
        </div>
      </paper-menu-button>
      <div class="title"></div>
      <content></content>
    </paper-toolbar>
  </template>

  <script>
    Polymer({
      is: 'lms-question-list-toolbar',

      behaviors: [
        Polymer.AppLocalizeBehavior,
        LMS.UtilBehavior,
        LMS.UserBehavior,
        LMS.LocaleBehavior
      ],
      
      properties: {
        filtersUrl: {
          type: String,
          notify: true
        },
        filtersParams: {
          type: Object,
          notify: true
        },
        filters: {
          type: Object,
          notify: true
        },
        selectedLevels: {
          type: Array,
          notify: true
        },
        selectedSubjects: {
          type: Array,
          notify: true
        },
        selectedTypes: {
          type: Array,
          notify: true
        },
        selectedOwners: {
          type: Array,
          notify: true
        }
      },

      attached: function() {
        this.$$('iron-ajax').generateRequest();
      },

      applyFilters: function() {
        var levels = this.$$('[name=levels]').selected;
        this.selectedLevels = [].concat(levels);

        var subjects = this.$$('[name=subjects]').selected;
        this.selectedSubjects = [].concat(subjects);

        var types = this.$$('[name=types]').selected;
        this.selectedTypes = [].concat(types);

        var owners = this.$$('[name=owners]').selected;
        this.selectedOwners = [].concat(owners);
      },

      resetFilters: function() {
        this.$$('[name=levels]').selected = 'ALL';
        this.$$('[name=subjects]').selected = 'ALL';
        this.$$('[name=types]').selected = 'ALL';
        this.$$('[name=owners]').selected = 'ANYONE';

        this.selectedLevels = ['ALL'];
        this.selectedSubjects = ['ALL'];
        this.selectedTypes = ['ALL'];
        this.selectedOwners = ['ANYONE'];
      },

      _onAjaxResponse: function(event) {
        this.filters = event.detail.response;
      },

      _onResetTap: function(event) {
        this.resetFilters();
        this.$$('paper-menu-button').close();
      },

      _onApplyTap: function(event) {
        this.$$('paper-menu-button').close();
        this.applyFilters();
      }
    });
  </script>

</dom-module>