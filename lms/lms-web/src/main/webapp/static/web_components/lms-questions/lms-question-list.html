<link rel="import" href="../lms-default.html">
<link rel="import" href="../lms-style.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<dom-module id="lms-question-list">

  <template strip-whitespace>
    <style include="lms-style">
      .list-item.active {
        z-index: 1;
      }

      .question {
        margin: 0 0 12px 0;
        padding: 16px;
      }

      .question .question {
        margin: 8px 0 0 8px;
        padding: 0;
      }

      .question .question-type {
        font-weight: bold;
        margin-bottom: 8px;
      }

      .question-content {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
    </style>

    <iron-ajax url="[[restUrl]]" params="[[restParams]]" method="GET"
               handle-as="json" content-type="application/json"
               loading="{{loading}}" on-response="_onAjaxResponse"></iron-ajax>

    <iron-list items="[[questions]]" as="question" selected-item={{selectedQuestion}}
               scroll-target="document" selection-enabled>
      <template>
        <div class="list-item" on-tap="_onItemTap">
          <div class="box question" flex-horizontal>
            <div class="question-content">
              <div class="question-type">
                <template is="dom-if" if="[[_equals(question.type, 'MULTIPLE_CHOICE')]]">
                  [[localize('labelMultipleChoice')]]
                </template>
                <template is="dom-if" if="[[_equals(question.type, 'MULTIPLE_RESPONSE')]]">
                  [[localize('labelMultipleResponse')]]
                </template>
                <template is="dom-if" if="[[_equals(question.type, 'SHORT_ANSWER')]]">
                  [[localize('labelShortAnswer')]]
                </template>
                <template is="dom-if" if="[[_equals(question.type, 'ESSAY')]]">
                  [[localize('labelEssay')]]
                </template>
                <template is="dom-if" if="[[_equals(question.type, 'COMPOSITE')]]">
                  [[localize('labelComposite')]]
                </template>
              </div>
              <div class="question-body">
                [[question.body]]
              </div>
              <template is="dom-if" if="[[_hasQuestions(question)]]">
                <template is="dom-repeat" items="[[question.questions]]" as="question">
                  <div class="question">
                    <div class="question-body">
                      [[question.body]]
                    </div>
                  </div>
                </template>
              </template>
            </div>
            <div class="question-actions">
              <paper-menu-button horizontal-align="right">
                <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                <paper-menu class="dropdown-content">
                  <paper-item>Share</paper-item>
                  <paper-item>Delete</paper-item>
                </paper-menu>
              </paper-menu-button>
            </div>
          </div>
        </div>
      </template>
    </iron-list>

    <div class="loading-status" hidden$="[[!loading]]">
      <paper-spinner active$="[[loading]]"></paper-spinner>
      [[localize('labelFetchingQuestions')]]
    </div>

    <iron-scroll-threshold lower-threshold="500" on-lower-threshold="_onLoadMore"
                           scroll-target="document"></iron-scroll-threshold>
  </template>

  <script>
    Polymer({
      is: 'lms-question-list',

      behaviors: [
        Polymer.AppLocalizeBehavior,
        LMS.UtilBehavior,
        LMS.UserBehavior,
        LMS.LocaleBehavior
      ],
      
      properties: {
        restUrl: {
          type: String,
          notify: true
        },
        restParams: {
          type: Object,
          notify: true
        },
        resetList: {
          type: Boolean,
          notify: true
        },
        loading: {
          type: Boolean,
          notify: true
        },
        elapsedTime: {
          type: Number,
          notify: true
        },
        numFound: {
          type: Number,
          notify: true
        },
        questions: {
          type: Array,
          notify: true
        },
        selectedQuestion: {
          type: Object,
          notify: true
        },
        loading: {
          type: Boolean,
          notify: true
        }
      },

      attached: function() {
        this.$$('iron-ajax').auto = true;
      },

      _hasQuestions: function(question) {
        return question.questions
          && (question.questions.length > 0);
      },

      _onAjaxResponse: function(event) {
        var response = event.detail.response;
        this.questions = this.questions || [];

        if (this.resetList) {
          this.set('questions', []);
        }

        response.items.forEach(function(item) {
          this.push('questions', item);
        }, this);

        this.numFound = response.numFound;
        this.resetList = true;
        this.$$('iron-scroll-threshold').clearTriggers();
      },

      _onLoadMore: function() {
        var offset = this.offset;
        var limit = this.limit;
        var count = (offset + 1) * limit;

        if (this.numFound && (count < 1000)) {
          this.resetList = false;
          this.offset = offset + 1;

        } else {
          this.$$('iron-scroll-threshold').clearTriggers();
        }
      },

      _onItemTap: function(event) {
        Polymer.dom(this.root).querySelectorAll('.list-item')
          .forEach(function(item) {
            item.classList.remove('active');
          });

        event.currentTarget.classList.add('active');
      }
    });
  </script>

</dom-module>