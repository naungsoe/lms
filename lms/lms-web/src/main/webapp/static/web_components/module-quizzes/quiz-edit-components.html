<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-sorter/iron-sorter.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../web_components/app-component-styles.html">
<link rel="import" href="../../web_components/module-quizzes/quiz-view-section.html">
<link rel="import" href="../../web_components/module-quizzes/quiz-edit-section.html">
<link rel="import" href="../../web_components/module-questions/question-view-multiple-choice.html">
<link rel="import" href="../../web_components/module-questions/question-view-multiple-response.html">
<link rel="import" href="../../web_components/module-questions/question-edit-multiple-choice.html">
<link rel="import" href="../../web_components/module-questions/question-edit-multiple-response.html">

<dom-module id="quiz-edit-components">
  <template>
    <style include="paper-button-styles">
      .quiz-component {
        @apply --layout-vertical;
        padding: 8px 16px 8px 8px;
      }

      .quiz-component[active]:not(.section-component) {
        @apply --shadow-elevation-4dp;
      }

      .quiz-component .content {
        @apply --layout-horizontal;
      }

      .quiz-component .content .component {
        @apply --layout-flex;
      }

      .quiz-component .header {
        @apply --layout-horizontal;
        @apply --layout-end-justified;
      }

      .quiz-component.drop-placeholder {
        border: 1px dashed var(--border-color);
      }

      .quiz-component.drop-placeholder * {
        @apply --layout-invisible;
      }

      .quiz-component.drag-item {
        @apply --shadow-elevation-2dp;
        background-color: var(--secondary-background-color);
      }

      .section-component {
        border-top: 1px solid var(--border-color);
        margin: 24px 0 8px;
        padding: 0 8px;
      }

      .section-component .header .title {
        @apply --paper-font-subhead;
        @apply --layout-flex;
        color: var(--secondary-text-color);
        padding: 8px;
      }

      .component-actions {
        margin-top: 12px;
        padding: 0 16px;
      }
    </style>

    <iron-ajax
        name="get"
        url="[[restUrl]]/[[quizId]]"
        method="GET"
        handle-as="json"
        content-type="application/json"
        loading="{{loading}}"
        last-response="{{quiz}}">
    </iron-ajax>

    <iron-ajax
        name="post"
        body="[[quiz]]"
        method="POST"
        handle-as="json"
        content-type="application/json"
        loading="{{loading}}"
        last-response="_handleSaveResponse">
    </iron-ajax>

    <template
        name="section"
        is="dom-repeat"
        items="[[quiz.components]]"
        as="component">
      <div
          class="quiz-component section-component"
          active$="[[_isEditingComponent(component, editingComponent)]]"
          on-tap="_handleComponentTap">
        <div class="header">
          <div class="title">
            [[localize('labelSection', 'offset', component.order,
              'length', quiz.components.length)]]
          </div>

          <paper-menu-button
              restore-focus-on-close="[[restoreFocusOnClose]]"
              horizontal-align="right"
              vertical-align="top">
            <paper-icon-button
                slot="dropdown-trigger"
                icon="more-vert">
            </paper-icon-button>

            <div slot="dropdown-content">
              <paper-listbox slot="dropdown-content">
                <paper-item value="move">
                  [[localize('labelSectionMove')]]
                </paper-item>
                <paper-item value="clone">
                  [[localize('labelSectionDuplicate')]]
                </paper-item>
                <paper-item value="delete">
                  [[localize('labelSectionDelete')]]
                </paper-item>
                <paper-item value="merge">
                  [[localize('labelSectionMerge')]]
                </paper-item>
              </paper-listbox>
            </div>
          </paper-menu-button>
        </div>

        <div class="content">
          <div class="component">
            <template
                is="dom-if"
                if="[[!_isEditingComponent(component, editingComponent)]]">
              <quiz-view-section
                  section="{{component}}"
                  language="[[language]]"
                  resources="[[resources]]">
              </quiz-view-section>
            </template>

            <template
                is="dom-if"
                if="[[_isEditingComponent(component, editingComponent)]]">
              <quiz-edit-section
                  section="{{component}}"
                  language="[[language]]"
                  resources="[[resources]]">
              </quiz-edit-section>
            </template>
          </div>
        </div>
      </div>

      <iron-sorter
          handle="component-handle"
          draggable="draggable-component"
          on-order-changed="_handleOrderChange">
        <template
            name="component"
            is="dom-repeat"
            items="[[component.components]]"
            as="component">
          <div
              class="quiz-component draggable-component"
              active$="[[_isEditingComponent(component, editingComponent)]]"
              on-tap="_handleComponentTap">
            <template
                is="dom-if"
                if="[[_isEditingComponent(component, editingComponent)]]">
              <div class="header">
                <paper-icon-button
                    icon="content-copy"
                    on-tap="_handleCloneTap">
                </paper-icon-button>

                <paper-icon-button
                    icon="delete"
                    on-tap="_handleDeleteTap">
                </paper-icon-button>
              </div>
            </template>

            <div class="content">
              <paper-icon-button
                  icon="editor:drag-handle"
                  class="component-handle">
              </paper-icon-button>

              <div class="component">
                <template
                    is="dom-if"
                    if="[[!_isEditingComponent(component, editingComponent)]]">
                  <template
                      is="dom-if"
                      if="[[_isMultipleChoice(component)]]">
                    <question-view-multiple-choice
                        question="{{component.question}}"
                        language="[[language]]"
                        resources="[[resources]]">
                    </question-view-multiple-choice>
                  </template>

                  <template
                      is="dom-if"
                      if="[[_isMultipleResponse(component)]]">
                    <question-view-multiple-response
                        question="{{component.question}}"
                        language="[[language]]"
                        resources="[[resources]]">
                    </question-view-multiple-response>
                  </template>
                </template>

                <template
                    is="dom-if"
                    if="[[_isEditingComponent(component, editingComponent)]]">
                  <template
                      is="dom-if"
                      if="[[_isMultipleChoice(component)]]">
                    <question-edit-multiple-choice
                        question="{{component.question}}"
                        language="[[language]]"
                        resources="[[resources]]">
                    </question-edit-multiple-choice>
                  </template>

                  <template
                      is="dom-if"
                      if="[[_isMultipleResponse(component, editingComponent)]]">
                    <question-edit-multiple-response
                        question="{{component.question}}"
                        language="[[language]]"
                        resources="[[resources]]">
                    </question-edit-multiple-response>
                  </template>
                </template>
              </div>
            </div>
          </div>
        </template>
      </iron-sorter>

      <div class="component-actions">
        <paper-button on-tap="_handleAddSectionTap">
          <iron-icon icon="add"></iron-icon>
          [[localize('buttonAddSection')]]
        </paper-button>

        <paper-menu-button>
          <paper-button slot="dropdown-trigger">
            <iron-icon icon="add"></iron-icon>
            [[localize('buttonAddQuestion')]]
          </paper-button>

          <paper-listbox
              slot="dropdown-content"
              attr-for-selected="value"
              on-selected-item-changed="_handleMenuSelect">
            <template
                is="dom-repeat"
                items="[[types]]"
                as="type">
              <paper-item value="[[type.value]]">
                [[type.name]]
              </paper-item>
            </template>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </template>
  </template>

  <script>
    const QuizEditComponentsBase = Polymer.mixinBehaviors(
      [Polymer.AppLocalizeBehavior], Polymer.Element);

    class QuizEditComponents extends QuizEditComponentsBase {
      static get is() {
        return 'quiz-edit-components';
      }

      static get properties() {
        return {
          restUrl: {
            type: String,
            readOnly: false,
            notify: true
          },
          filterOptions: {
            type: Object,
            readOnly: false,
            notify: true
          },
          quiz: {
            type: Object,
            readOnly: false,
            notify: true
          },
          editingComponent: {
            type: Object,
            readOnly: false,
            notify: true
          }
        };
      }

      _isEditingComponent(component, editingComponent) {
        return component === editingComponent;
      }

      _isMultipleChoice(component) {
        return component.question.type === 'MultipleChoice';
      }

      _isMultipleResponse(component) {
        return component.question.type === 'MultipleResponse';
      }

      _handleComponentTap(event) {
        let path = Polymer.dom(event).path;
        let menuInPath = false;

        for (var i = 0; i < path.length; i++) {
          if (path[i].tagName === 'PAPER-MENU-BUTTON') {
            menuInPath = true;
            break;
          }
        }

        if (!menuInPath) {
          this.editingComponent = event.model.component;
        }
      }

      _handleAddSectionTap(event) {
        let root = this.shadowRoot;
        let template = root.querySelector('dom-repeat[name=section]');
        let section = template.itemForElement(event.target);
        var index = this.quiz.components.indexOf(section);
        this.quiz.components.forEach(function(component, compIndex) {
          if (compIndex > index) {
            component.order = component.order + 1;
          }
        });

        let order = section.order + 1;
        let component = {
          id: '',
          title: '',
          instructions: '',
          order: order,
          components: []
        };
        this.editingComponent = component;
        this.quiz.components.splice((index + 1), 0, component);
        this.notifySplices('quiz.components');
      }

      _handleMenuSelect(event) {
        if (event.detail.value === null) {
          return;
        }

        let root = this.shadowRoot;
        let template = root.querySelector('dom-repeat[name=section]');
        let section = template.itemForElement(event.target);
        var index = this.quiz.components.indexOf(section);

        let order = section.components.length + 1;
        let component = {
          id: '',
          question: {
            type: 'MultipleChoice',
            body: '',
            hint: '',
            explanation: '',
            options: [
              {
                id: '',
                body: 'Option 1',
                feedback: '',
                correct: false,
                order: 1
              },
              {
                id: '',
                body: 'Option 2',
                feedback: '',
                correct: false,
                order: 2
              }
            ]
          },
          score: 0,
          order: order
        };
        this.editingComponent = component;
        section.components.push(component);

        let path = 'quiz.components.' + index + '.components';
        this.notifySplices(path);
      }
    }
    customElements.define(QuizEditComponents.is, QuizEditComponents);
  </script>
</dom-module>