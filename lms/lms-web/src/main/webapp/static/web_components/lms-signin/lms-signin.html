<link rel="import" href="../lms-default.html">
<link rel="import" href="../lms-style.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<dom-module id="lms-signin">

  <template strip-whitespace>
    <style include="lms-style">
      :host {
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        background-color: var(--paper-grey-50);
        height: 100vh;
        width: 100vw;
      }

      paper-card {
        width: 320px;
      }

      paper-card .card-actions {
        border: 0 !important;
        margin: 0 0 16px 0;
      }

      paper-card .card-content paper-input {
        padding: 8px 0;
      }

      .module-actions {
        margin: 16px 0;
      }
    </style>

    <form name="signIn" method="post" action="[[signInUrl]]">
      <paper-card heading="[[localize('titleCard')]]"
                  alt="[[localize('titleCard')]]" sign-in>
        <div class="card-content">
          <paper-input name="id" label="[[localize('labelId')]]"
                       value="{{id}}" type="text" autocomplete="off"
                       error-message="[[localize('labelIdRequired')]]"
                       on-keydown="_handleKeydown"
                       autofocus no-label-float required></paper-input>
          <paper-input name="password" label="[[localize('labelPassword')]]"
                       value="{{password}}" type="password" autocomplete="new-password"
                       error-message="[[localize('labelPasswordRequired')]]"
                       on-keydown="_handleKeydown"
                       no-label-float required></paper-input>
          <template is="dom-if" if="[[captchaRequired]]">
            <br/>
            <img src="[[captchaUrl]]" alt="[[localize('altCaptcha')]]"/>
            <paper-input name="captcha" label="[[localize('labelCaptcha')]]"
                         value="{{captcha}}" type="text" autocomplete="off"
                         error-message="[[localize('labelCaptchaRequired')]]"
                         on-keydown="_handleKeydown"
                         no-label-float required></paper-input>
          </template>
          <div class="error" hidden$="[[_hideError(error, 'errorCredential')]]">
            [[localize('errorCredential')]]
          </div>
        </div>
        <div class="card-actions">
          <paper-button on-tap="_handleSignIn" class="primary">
            [[localize('buttonSignIn')]]
          </paper-button>
          <paper-button on-tap="_handleAccountHelp">
            [[localize('buttonAccountHelp')]]
          </paper-button>
        </div>
      </paper-card>
    </form>

    <div class="module-actions">
      <paper-button on-tap="_handleSignUp" class="link">
        [[localize('buttonSignUp')]]
      </paper-button>
    </div>
  </template>

  <script>
    Polymer({
      is: 'lms-signin',

      behaviors: [
        Polymer.AppLocalizeBehavior,
        LMS.LocaleBehavior
      ],
      
      properties: {
        id: {
          type: String,
          notify: true
        },
        password: {
          type: String,
          notify: true
        },
        error: {
          type: String,
          notify: true
        },
        captcha: {
          type: String,
          notify: true
        },
        captchaRequired: {
          type: Boolean,
          notify: true
        },
        captchaUrl: {
          type: String,
          notify: true
        },
        signInUrl: {
          type: String,
          notify: true
        },
        accountHelpUrl: {
          type: String,
          notify: true
        },
        signUpUrl: {
          type: String,
          notify: true
        }
      },

      _hideError(error, placeholder) {
        return (error !== placeholder);
      },

      _handleKeydown: function(event) {
        if (event.keyCode === 13) {
          this._handleSignIn();
        }
      },

      _handleSignIn: function(event) {
        var valid = this.$$('[name=id]').validate();
        valid = this.$$('[name=password]').validate() && valid;

        if (this.$$('[name=captcha]') != null) {
          valid = this.$$('[name=captcha]').validate() && valid;
        }

        if (valid) {
          this.$$('[name=signIn]').submit();
        } else {
          this.error = '';
        }
      },

      _handleAccountHelp: function(event) {
        window.location = this.accountHelpUrl;
      },

      _handleSignUp: function(event) {
        window.location = this.signUpUrl;
      }
    });
  </script>

</dom-module>